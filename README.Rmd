---
title: ""
output: github_document
---

# lastdose 

Calculate the time since and amount of the last dose. Additional (`ADDL`) 
dosing records are expanded and included in the calculation.


<hr>

```{r,include=FALSE}
knitr::opts_chunk$set(comment = '.', message=FALSE, warning = FALSE, 
                      fig.path="man/figures/readme-")
```


```{r,message=FALSE}
library(lastdose)
library(tidyverse)
theme_set(theme_bw())

file <- system.file("csv/data1.csv", package = "lastdose")

df <- read.csv(file) 

head(df)
```

## A PK profile
```{r}
df %>% filter(EVID==1) %>% count(TIME,AMT,ADDL)

ggplot(df, aes(TIME,DV)) + geom_line() + theme_bw()
```


# Plot last dose versus time
```{r}
df <- lastdose(df)

ggplot(df, aes(TIME,LDOS)) + geom_line()
```

# Plot time after dose versus time

```{r}
ggplot(df, aes(TIME,TAD)) + geom_line()

ggplot(df, aes(TIME,TAD)) + geom_line() + 
  scale_x_continuous(breaks = seq(0,72,4), limits=c(0,72)) + 
  scale_y_continuous(breaks = seq(0,24,4), limits=c(0,24)) 

```

# All doses explicit in the data set
```{r}
df2 <- mrgsolve::realize_addl(df) 

df2 <- lastdose(df2)

ggplot(df2, aes(TIME,TAD)) + geom_line()

ggplot(df2, aes(TIME,TAD)) + geom_line() + 
  scale_x_continuous(breaks = seq(0,72,4), limits = c(0,72)) + 
  scale_y_continuous(breaks = seq(0,24,4))
```


# How does it perform on bigger data?

Same setup as the previous profile, but more individuals.

We have 500K rows and 1000 individuals

```{r}
file <- system.file("csv/data_big.RDS", package = "lastdose")

big <- readRDS(file)

dim(big)

length(unique(big$ID))
```

Timing result
```{r}
system.time(x2 <- lastdose(big))
```

## Compare against the single profile
```{R}
system.time(x1 <- lastdose(df))

x3 <- filter(x2, big[["ID"]]==1) %>% as.data.frame()

all.equal(x1,x3)

```

# Observations prior to the first dose

When non-dose records happen prior to the first dose, lastdose calculates
the time before the first dose (a negative value) for these records.

```{r}
file <- system.file("csv/data2.csv", package = "lastdose")

df <- read_csv(file)

lastdose(df) %>% head()
```

The user can alternatively control what happens for these records

```{r}
lastdose(df, fill = NA_real_, back_calc=FALSE) %>% head()
```

